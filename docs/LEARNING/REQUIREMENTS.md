# 要件定義書 - リアルタイムチャットアプリケーション

## 1. プロジェクト概要

技術学習者向けのリアルタイムチャットプラットフォーム。Slack/Discordのような機能を持ち、テキストベースのコミュニケーション、ファイル共有、スレッド機能、AIアシスタントによる学習支援を提供する。

**プロジェクト名**: studying-tech-chat-app
**開発期間**: 卒業制作プロジェクト
**対象ユーザー**: プログラミング学習者、技術コミュニティメンバー
**リポジトリ**: https://github.com/Ishikawa-Yutaka/studying-chat-app

---

## 2. 解決する問題

### 2.1 課題

1. **学習中の孤独感**: プログラミング学習者は疑問点をすぐに質問できる環境が少ない
2. **情報の分散**: 複数のツール（Slack、Discord、ChatGPT）を使い分ける必要がある
3. **非同期コミュニケーションの限界**: メール等では即座の対話ができない
4. **学習コンテキストの喪失**: 過去の質問・回答が埋もれて見つけにくい
5. **AI支援の不在**: チャット内でAIに質問できる統合環境がない

### 2.2 解決策

- **リアルタイムチャット**: WebSocketによる即座のメッセージ配信
- **AIアシスタント統合**: OpenAI GPT-4o-miniを活用した学習支援
- **ファイル共有**: 画像・ドキュメントの共有機能
- **スレッド機能**: メッセージへの返信を整理
- **チャンネル/DM機能**: 目的別に会話を整理
- **オンライン状態表示**: 相手の在席状況を確認可能
- **検索機能**: ユーザー・チャンネルをリアルタイム検索
- **ダークモード**: 目に優しいダークテーマ切り替え
- **ソーシャルログイン**: Google/GitHubで簡単ログイン
- **履歴管理**: データベースに全メッセージを保存

---

## 3. 主要機能

### 3.1 完成済み機能

| 機能カテゴリ | 機能 | 説明 |
|------------|------|------|
| **認証** | メール認証 | Supabase Authによるサインアップ/ログイン |
| | ソーシャルログイン | Google OAuth、GitHub OAuth対応 |
| | セッション管理 | Next.js Middlewareで全ページを保護 |
| | アカウント削除 | ユーザーが自分のアカウントを削除可能 |
| **チャット** | チャンネルチャット | 複数人でのグループ会話 |
| | ダイレクトメッセージ | 1対1のプライベート会話 |
| | リアルタイム配信 | Supabase Realtimeによる即時メッセージ配信 |
| | 楽観的更新 | 送信者は即座に画面更新 |
| | スレッド機能 | メッセージへの返信機能（Slack風UI） |
| **ファイル共有** | アップロード | 画像・動画・ドキュメント対応（最大10MB） |
| | ファイル形式 | PNG, JPEG, GIF, WebP, MP4, PDF, Office形式など |
| | プレビュー | ファイルプレビュー・ダウンロード機能 |
| **チャンネル管理** | チャンネル作成 | 新しいチャンネルの作成 |
| | チャンネル参加 | 参加可能なチャンネル一覧から参加 |
| | チャンネル退出 | チャンネルから退出 |
| | チャンネル削除 | 作成者のみ削除可能 |
| **DM管理** | DM作成 | 他のユーザーとのDM開始 |
| | DM退出 | DM退出（メッセージ履歴保持） |
| | 履歴保持 | 退出後も再度開くと同じチャンネルが復活 |
| **AI機能** | AI会話 | OpenAI GPT-4o-miniとの会話 |
| | セッション管理 | 会話を複数のセッションで管理 |
| | 会話履歴保存 | 過去の会話を保存・閲覧可能 |
| | コンテキスト保持 | 過去20件の会話をコンテキストとして保持 |
| | 専用UI | /workspace/ai-chat ページで利用可能 |
| **オンライン状態** | リアルタイム表示 | Supabase Presenceによるオンライン状態追跡 |
| | アバター表示 | ユーザーアバター横にオンライン表示 |
| | 最終オンライン時刻 | 最後にオンラインだった時刻を記録 |
| **検索機能** | ユーザー検索 | ユーザー名・メールアドレスで検索 |
| | チャンネル検索 | チャンネル名・説明で検索 |
| | リアルタイムフィルタリング | 入力中に即座に結果を絞り込み |
| **プロフィール** | アバター画像 | プロフィール画像のアップロード・変更 |
| | プロフィール表示 | ユーザー名・メールアドレス表示 |
| **UI/UX** | レスポンシブデザイン | デスクトップ/モバイル対応 |
| | ダークモード | ライト/ダークテーマ切り替え（next-themes） |
| | サイドバー | チャンネル一覧、DM一覧 |
| | モバイルサイドバー | モバイル専用サイドバーUI |
| | 統計情報 | ダッシュボードに統計情報表示 |
| | スムーズアニメーション | テーマ切り替え時のトランジション効果 |

### 3.2 未実装機能（優先順位順）

1. **メッセージ編集・削除** (S): 送信後のメッセージを編集・削除
2. **チャンネル編集** (S): チャンネル名・説明の編集
3. **通知機能** (S): ブラウザ通知、プッシュ通知
4. **メッセージ検索** (C): メッセージ全文検索
5. **リアクション機能** (C): メッセージへの絵文字リアクション
6. **コードシンタックスハイライト** (C): コードブロックの構文強調表示
7. **ユーザー名変更** (C): 表示名のカスタマイズ
8. **プライベートチャンネル** (C): 招待制チャンネル

---

## 4. 競合アプリ分析

| アプリ | 強み | 弱み | 本プロジェクトの差別化 |
|-------|------|------|---------------------|
| **Slack** | - エンタープライズ向け機能<br>- 豊富なインテグレーション<br>- 安定した動作 | - 学習者向け機能なし<br>- 無料プランの制限が厳しい<br>- AI統合なし | **AI学習支援の統合**<br>チャット内でGPT-4o-miniに質問可能 |
| **Discord** | - ゲーマー向けUI<br>- 音声通話が強力<br>- 無料で多機能 | - ビジネス用途に不向き<br>- 学習コンテキストの管理が弱い<br>- AI機能なし | **学習履歴の整理・検索**<br>AIとの会話履歴を保存・管理 |
| **ChatGPT** | - 高度なAI対話<br>- 自然言語処理が優秀 | - チームコラボレーション機能なし<br>- リアルタイムチャット機能なし | **チャット + AI の融合**<br>チーム会話とAI支援の両立 |
| **Microsoft Teams** | - Office 365統合<br>- 企業向けセキュリティ | - 個人利用には複雑<br>- 学習者向けではない | **シンプルで学習に特化**<br>プログラミング学習者向けUX |

### 本プロジェクトの独自価値

1. **学習者ファースト**: プログラミング学習に最適化されたUX
2. **AI統合**: チャット内でGPT-4o-miniに質問可能（専用ページあり）
3. **完全なファイル共有**: 画像・ドキュメント・動画を簡単に共有
4. **スレッド機能**: Slack風のスレッド機能でメッセージを整理
5. **オンライン状態表示**: Supabase Presenceによるリアルタイム追跡
6. **ソーシャルログイン**: Google/GitHubで簡単アクセス
7. **ダークモード**: 目に優しいダークテーマ標準装備
8. **検索機能**: ユーザー・チャンネルをリアルタイム検索
9. **軽量・高速**: Next.js 15 + Supabaseの最新スタックで高速動作
10. **オープンソース**: GitHub公開予定、学習教材としても活用可能

---

## 5. ユーザーストーリー

### 5.1 認証・アカウント管理

- **M**: ユーザーとして、メールアドレスでアカウント登録したい。なぜなら個人を特定できるようにしたいからだ。
- **M**: ユーザーとして、ログインしたい。なぜなら自分のアカウントでアプリを使いたいからだ。
- **M**: ユーザーとして、Google/GitHubでログインしたい。なぜならアカウント作成の手間を省きたいからだ。
- **M**: ユーザーとして、アカウントを削除したい。なぜならサービスの利用を終了したいからだ。
- **M**: ユーザーとして、プロフィール画像を設定したい。なぜなら視覚的に自分を識別しやすくしたいからだ。
- **C**: ユーザーとして、ユーザー名を変更したい。なぜなら表示名をカスタマイズしたいからだ。
- **W**: ユーザーとして、2段階認証を有効にしたい。なぜならセキュリティを強化したいからだ。

### 5.2 チャンネル管理

- **M**: ユーザーとして、新しいチャンネルを作成したい。なぜなら特定のトピックについて議論する場所が欲しいからだ。
- **M**: ユーザーとして、チャンネル一覧を表示したい。なぜなら参加可能なチャンネルを把握したいからだ。
- **M**: ユーザーとして、チャンネルを検索したい。なぜなら興味のあるチャンネルをすぐに見つけたいからだ。
- **M**: ユーザーとして、チャンネルに参加したい。なぜなら興味のあるトピックの会話に参加したいからだ。
- **M**: ユーザーとして、チャンネルから退出したい。なぜなら興味がなくなったチャンネルを整理したいからだ。
- **M**: ユーザーとして、自分が作成したチャンネルを削除したい。なぜなら不要になったチャンネルを削除したいからだ。
- **S**: ユーザーとして、チャンネルの説明を編集したい。なぜならチャンネルの目的を明確にしたいからだ。
- **C**: ユーザーとして、プライベートチャンネルを作成したい。なぜなら限定メンバーだけで話したいからだ。
- **W**: ユーザーとして、チャンネルをアーカイブしたい。なぜなら使わなくなったチャンネルを非表示にしたいからだ。

### 5.3 メッセージング

- **M**: ユーザーとして、テキストメッセージを送信したい。なぜなら他のユーザーと会話したいからだ。
- **M**: ユーザーとして、リアルタイムでメッセージを受信したい。なぜなら即座に返信できるようにしたいからだ。
- **M**: ユーザーとして、過去のメッセージを閲覧したい。なぜなら会話の履歴を確認したいからだ。
- **M**: ユーザーとして、DMを送信したい。なぜなら個別に連絡を取りたいからだ。
- **M**: ユーザーとして、スレッドで返信したい。なぜなら特定のメッセージに対する会話を整理したいからだ。
- **M**: ユーザーとして、ファイルを共有したい。なぜなら画像やPDFを他のメンバーと共有したいからだ。
- **S**: ユーザーとして、メッセージを編集したい。なぜなら誤字を修正したいからだ。
- **S**: ユーザーとして、メッセージを削除したい。なぜなら不適切な内容を送信してしまった場合に取り消したいからだ。
- **C**: ユーザーとして、メッセージを検索したい。なぜなら過去の会話から情報を見つけたいからだ。
- **C**: ユーザーとして、メッセージにリアクション（絵文字）を付けたい。なぜなら簡単にフィードバックしたいからだ。
- **C**: ユーザーとして、コードブロックをシンタックスハイライト付きで送信したい。なぜなら技術的な内容を読みやすくしたいからだ。
- **W**: ユーザーとして、メッセージをピン留めしたい。なぜなら重要な情報を常に上部に表示したいからだ。

### 5.4 AIチャットボット

- **M**: ユーザーとして、AIアシスタントに質問したい。なぜなら学習中の疑問をすぐに解決したいからだ。
- **M**: ユーザーとして、AI会話履歴を保存したい。なぜなら後で見返したいからだ。
- **M**: ユーザーとして、複数のAIセッションを管理したい。なぜなら異なるトピックの会話を分けたいからだ。
- **C**: ユーザーとして、AIとのチャットを他のメンバーと共有したい。なぜなら有益な情報をチームで活用したいからだ。
- **C**: ユーザーとして、AIにコードレビューを依頼したい。なぜなら改善点を知りたいからだ。
- **W**: ユーザーとして、AIの回答精度を評価したい。なぜならフィードバックで改善に貢献したいからだ。

### 5.5 通知・検索

- **M**: ユーザーとして、ユーザーを検索したい。なぜなら特定のユーザーを見つけてDMを送りたいからだ。
- **M**: ユーザーとして、チャンネルを検索したい。なぜなら参加したいチャンネルを見つけたいからだ。
- **S**: ユーザーとして、新着メッセージの通知を受け取りたい。なぜなら重要なメッセージを見逃したくないからだ。
- **C**: ユーザーとして、メッセージを検索したい。なぜなら過去の会話から情報を見つけたいからだ。
- **C**: ユーザーとして、通知設定をカスタマイズしたい。なぜなら重要なチャンネルだけ通知を受け取りたいからだ。
- **W**: ユーザーとして、@メンション機能を使いたい。なぜなら特定のユーザーに確実に通知したいからだ。

### 5.6 UI/UX

- **M**: ユーザーとして、モバイルデバイスでもアプリを使いたい。なぜなら外出先でも会話に参加したいからだ。
- **M**: ユーザーとして、オンラインステータスを確認したい。なぜなら相手が今返信できるか知りたいからだ。
- **M**: ユーザーとして、ダークモードを使いたい。なぜなら夜間の目の負担を減らしたいからだ。
- **W**: ユーザーとして、キーボードショートカットを使いたい。なぜなら効率的に操作したいからだ。

---

## 6. 優先度定義

### Must Have（必須）- M

プロジェクトの核となる機能。これがないとアプリとして成立しない。

**完成済み**:
- 認証（メール/ソーシャルログイン）
- チャンネルチャット
- チャンネル作成・参加・退出・削除
- ダイレクトメッセージ
- DM作成・退出
- リアルタイムメッセージ配信
- メッセージ履歴表示
- スレッド機能
- ファイル共有（画像・ドキュメント・動画）
- AIチャットボット（GPT-4o-mini）
- AI会話履歴保存
- AIセッション管理
- オンラインステータス表示
- ユーザー検索
- チャンネル検索
- プロフィール画像設定
- ダークモード
- アカウント削除
- レスポンシブUI

### Should Have（重要）- S

ユーザー体験を大きく向上させる機能。

**未実装**:
- メッセージ編集・削除
- チャンネル編集
- 通知機能

### Could Have（あれば良い）- C

時間があれば実装したい付加価値機能。

- メッセージ検索
- リアクション機能
- ユーザー名変更
- コードシンタックスハイライト
- 通知設定カスタマイズ
- AIチャット共有機能
- プライベートチャンネル

### Won't Have（今回は対象外）- W

将来的な拡張候補だが、卒業制作では実装しない。

- 2段階認証
- チャンネルアーカイブ
- @メンション機能
- キーボードショートカット
- メッセージピン留め
- AI回答評価機能

---

## 7. ストーリー一覧（チェックリスト形式）

### 認証・アカウント管理

- [x] M: ユーザーとして、アカウント登録したい。なぜなら個人を特定できるようにしたいからだ。
- [x] M: ユーザーとして、ログインしたい。なぜなら自分のアカウントでアプリを使いたいからだ。
- [x] M: ユーザーとして、Google/GitHubでログインしたい。なぜならアカウント作成の手間を省きたいからだ。
- [x] M: ユーザーとして、アカウントを削除したい。なぜならサービスの利用を終了したいからだ。
- [x] M: ユーザーとして、プロフィール画像を設定したい。なぜなら視覚的に自分を識別しやすくしたいからだ。
- [ ] C: ユーザーとして、ユーザー名を変更したい。なぜなら表示名をカスタマイズしたいからだ。

### チャンネル管理

- [x] M: ユーザーとして、新しいチャンネルを作成したい。なぜなら特定のトピックについて議論する場所が欲しいからだ。
- [x] M: ユーザーとして、チャンネル一覧を表示したい。なぜなら参加可能なチャンネルを把握したいからだ。
- [x] M: ユーザーとして、チャンネルを検索したい。なぜなら興味のあるチャンネルをすぐに見つけたいからだ。
- [x] M: ユーザーとして、チャンネルに参加したい。なぜなら興味のあるトピックの会話に参加したいからだ。
- [x] M: ユーザーとして、チャンネルから退出したい。なぜなら興味がなくなったチャンネルを整理したいからだ。
- [x] M: ユーザーとして、自分が作成したチャンネルを削除したい。なぜなら不要になったチャンネルを削除したいからだ。
- [ ] S: ユーザーとして、チャンネルの説明を編集したい。なぜならチャンネルの目的を明確にしたいからだ。
- [ ] C: ユーザーとして、プライベートチャンネルを作成したい。なぜなら限定メンバーだけで話したいからだ。

### メッセージング

- [x] M: ユーザーとして、テキストメッセージを送信したい。なぜなら他のユーザーと会話したいからだ。
- [x] M: ユーザーとして、リアルタイムでメッセージを受信したい。なぜなら即座に返信できるようにしたいからだ。
- [x] M: ユーザーとして、過去のメッセージを閲覧したい。なぜなら会話の履歴を確認したいからだ。
- [x] M: ユーザーとして、DMを送信したい。なぜなら個別に連絡を取りたいからだ。
- [x] M: ユーザーとして、スレッドで返信したい。なぜなら特定のメッセージに対する会話を整理したいからだ。
- [x] M: ユーザーとして、ファイルを共有したい。なぜなら画像やPDFを他のメンバーと共有したいからだ。
- [ ] S: ユーザーとして、メッセージを編集したい。なぜなら誤字を修正したいからだ。
- [ ] S: ユーザーとして、メッセージを削除したい。なぜなら不適切な内容を送信してしまった場合に取り消したいからだ。
- [ ] C: ユーザーとして、メッセージを検索したい。なぜなら過去の会話から情報を見つけたいからだ。
- [ ] C: ユーザーとして、メッセージにリアクション（絵文字）を付けたい。なぜなら簡単にフィードバックしたいからだ。
- [ ] C: ユーザーとして、コードブロックをシンタックスハイライト付きで送信したい。なぜなら技術的な内容を読みやすくしたいからだ。

### AIチャットボット

- [x] M: ユーザーとして、AIアシスタントに質問したい。なぜなら学習中の疑問をすぐに解決したいからだ。
- [x] M: ユーザーとして、AI会話履歴を保存したい。なぜなら後で見返したいからだ。
- [x] M: ユーザーとして、複数のAIセッションを管理したい。なぜなら異なるトピックの会話を分けたいからだ。
- [ ] C: ユーザーとして、AIとのチャットを他のメンバーと共有したい。なぜなら有益な情報をチームで活用したいからだ。
- [ ] C: ユーザーとして、AIにコードレビューを依頼したい。なぜなら改善点を知りたいからだ。

### 通知・検索

- [x] M: ユーザーとして、ユーザーを検索したい。なぜなら特定のユーザーを見つけてDMを送りたいからだ。
- [x] M: ユーザーとして、チャンネルを検索したい。なぜなら参加したいチャンネルを見つけたいからだ。
- [ ] S: ユーザーとして、新着メッセージの通知を受け取りたい。なぜなら重要なメッセージを見逃したくないからだ。
- [ ] C: ユーザーとして、メッセージを検索したい。なぜなら過去の会話から情報を見つけたいからだ。
- [ ] C: ユーザーとして、通知設定をカスタマイズしたい。なぜなら重要なチャンネルだけ通知を受け取りたいからだ。

### UI/UX

- [x] M: ユーザーとして、モバイルデバイスでもアプリを使いたい。なぜなら外出先でも会話に参加したいからだ。
- [x] M: ユーザーとして、オンラインステータスを確認したい。なぜなら相手が今返信できるか知りたいからだ。
- [x] M: ユーザーとして、ダークモードを使いたい。なぜなら夜間の目の負担を減らしたいからだ。

---

## 8. 技術スタック

### フロントエンド

| 技術 | バージョン | 用途 |
|------|-----------|------|
| **Next.js** | 15.5.4 | Reactフレームワーク、App Router使用 |
| **React** | 19 | UIライブラリ |
| **TypeScript** | 最新 | 型安全性確保 |
| **TailwindCSS** | 4 | スタイリング |
| **shadcn/ui** | 最新 | UIコンポーネントライブラリ |
| **next-themes** | 0.4.6 | ダークモード実装 |
| **React Hook Form** | 最新 | フォーム管理 |
| **Zod** | 最新 | バリデーション |

### バックエンド

| 技術 | バージョン | 用途 |
|------|-----------|------|
| **Next.js API Routes** | 15.5.4 | RESTful API |
| **Prisma ORM** | 最新 | データベースアクセス |
| **PostgreSQL** | 最新 | データベース（Supabase経由） |
| **OpenAI API** | 最新 | AIチャットボット（GPT-4o-mini） |

### インフラ・サービス

| サービス | 用途 |
|---------|------|
| **Supabase** | 認証、Realtime、Presence、Storage、データベースホスティング |
| **Vercel** | デプロイ（予定） |
| **GitHub** | バージョン管理 |

### 将来的に導入予定

| 技術 | 用途 |
|------|------|
| **Zustand** | グローバル状態管理 |
| **SWR** | データフェッチ・キャッシュ |

---

## 9. 進捗管理表

### フェーズ1: 基礎機能実装（完了）

| タスク | ステータス | 完了日 |
|--------|----------|--------|
| プロジェクトセットアップ | ✅ 完了 | - |
| Prismaスキーマ設計 | ✅ 完了 | - |
| Supabase認証統合 | ✅ 完了 | - |
| ログイン/サインアップUI | ✅ 完了 | - |
| ソーシャルログイン（Google/GitHub） | ✅ 完了 | - |
| チャンネルチャット機能 | ✅ 完了 | - |
| DM機能 | ✅ 完了 | - |
| Realtime統合 | ✅ 完了 | - |
| レスポンシブUI | ✅ 完了 | - |
| チャンネル作成UI | ✅ 完了 | - |
| チャンネル参加・退出 | ✅ 完了 | - |
| チャンネル削除（作成者のみ） | ✅ 完了 | - |
| ファイル共有機能 | ✅ 完了 | - |
| スレッド機能 | ✅ 完了 | - |
| AIチャットボット統合 | ✅ 完了 | - |
| AIセッション管理 | ✅ 完了 | - |
| オンラインステータス | ✅ 完了 | - |
| ユーザー検索 | ✅ 完了 | - |
| チャンネル検索 | ✅ 完了 | - |
| ダークモード | ✅ 完了 | - |
| プロフィール画像設定 | ✅ 完了 | - |
| アカウント削除 | ✅ 完了 | - |

### フェーズ2: 機能拡張（進行中）

| タスク | ステータス | 優先度 | 担当 |
|--------|----------|--------|------|
| メッセージ編集・削除 | 🔄 未着手 | S | - |
| チャンネル編集 | 🔄 未着手 | S | - |
| 通知機能（ブラウザ通知） | 🔄 未着手 | S | - |

### フェーズ3: 最適化・付加機能（未着手）

| タスク | ステータス | 優先度 | 担当 |
|--------|----------|--------|------|
| メッセージ検索 | 🔄 未着手 | C | - |
| リアクション機能 | 🔄 未着手 | C | - |
| ユーザー名変更 | 🔄 未着手 | C | - |
| コードシンタックスハイライト | 🔄 未着手 | C | - |
| プライベートチャンネル | 🔄 未着手 | C | - |
| SWR導入（キャッシュ最適化） | 🔄 未着手 | C | - |
| パフォーマンステスト | 🔄 未着手 | C | - |

### フェーズ4: デプロイ・ドキュメント（未着手）

| タスク | ステータス | 優先度 | 担当 |
|--------|----------|--------|------|
| Vercelデプロイ | 🔄 未着手 | M | - |
| README作成 | 🔄 未着手 | M | - |
| APIドキュメント作成 | 🔄 未着手 | S | - |
| 使い方ガイド作成 | 🔄 未着手 | S | - |

---

## 10. コンポーネント設計

### 10.1 ページ構成

```
src/app/
├── login/               # ログインページ（ソーシャルログインボタン含む）
├── signup/              # サインアップページ
│
├── workspace/           # メインアプリケーション（認証必須）
│   ├── layout.tsx      # サイドバー付きレイアウト
│   ├── page.tsx        # ダッシュボード
│   ├── channel/[channelId]/  # チャンネルページ（動的ルート）
│   ├── dm/[userId]/    # DMページ（動的ルート）
│   ├── ai-chat/        # AIチャットページ
│   └── settings/       # 設定ページ（未実装）
│
├── auth/callback/      # OAuth認証コールバック
│
└── api/                # APIルート
    ├── auth/          # 認証関連API（Supabase Auth連携）
    ├── channels/      # チャンネル管理API
    ├── messages/      # メッセージ操作API
    ├── threads/       # スレッド機能API
    ├── dm/            # DM関連API
    ├── upload/        # ファイルアップロードAPI
    ├── avatar/        # アバター画像API
    ├── ai/            # AI機能API
    ├── user/          # ユーザー情報API
    ├── users/         # ユーザー一覧API
    ├── channel-members/  # チャンネルメンバー一覧API
    └── dashboard/     # 統計情報API
```

### 10.2 コンポーネント階層

```
src/components/
├── ui/                         # 基本UIコンポーネント（shadcn/ui）
│   ├── button.tsx
│   ├── input.tsx
│   ├── card.tsx
│   ├── dialog.tsx
│   ├── avatar.tsx
│   └── ...
│
├── theme-provider.tsx          # ダークモード対応（next-themes）
│
├── workspace/                  # ワークスペース関連
│   ├── appLogo.tsx            # アプリロゴ
│   ├── channelList.tsx        # チャンネル一覧
│   ├── directMessageList.tsx  # DM一覧
│   ├── userManagement.tsx     # ユーザー管理（検索機能付き）
│   ├── userProfileBar.tsx     # ユーザープロフィールバー
│   ├── mobileSidebar.tsx      # モバイル対応サイドバー
│   ├── createChannelDialog.tsx  # チャンネル作成ダイアログ
│   ├── joinChannelDialog.tsx  # チャンネル検索・参加ダイアログ
│   ├── startDmDialog.tsx      # ユーザー検索・DM開始ダイアログ
│   ├── avatarSettingsDialog.tsx  # アバター設定ダイアログ
│   └── settingsMenu.tsx       # 設定メニュー（ダークモード切り替え）
│
├── channel/                    # チャンネル機能
│   ├── channelHeader.tsx      # チャンネルヘッダー
│   ├── messageView.tsx        # メッセージ一覧表示
│   ├── messageForm.tsx        # メッセージ送信フォーム
│   ├── threadPanel.tsx        # スレッドパネル（Slack風）
│   └── filePreviewModal.tsx   # ファイルプレビューモーダル
│
├── dm/                         # DM機能
│   └── dmHeader.tsx           # DMヘッダー
│
├── ai/                         # AI機能
│   ├── aiChatWidget.tsx       # AIチャットウィジェット
│   └── aiHistoryList.tsx      # AI会話履歴
│
└── shared/                     # 共通コンポーネント
    ├── loadingSpinner.tsx     # ローディング表示
    ├── errorBoundary.tsx      # エラーハンドリング
    ├── confirmDialog.tsx      # 確認ダイアログ
    └── userAvatar.tsx         # ユーザーアバター（オンライン状態表示）
```

### 10.3 カスタムフック

```
src/hooks/
├── useAuth.ts                  # 認証状態管理
├── useRealtimeMessages.ts      # リアルタイムメッセージ受信
├── useRealtimeDashboard.ts     # ダッシュボード統計リアルタイム更新
├── usePresence.ts              # オンライン状態のリアルタイム追跡
└── useOnlineStatusSync.ts      # オンライン状態の同期
```

### 10.4 Context

```
src/contexts/
└── PresenceContext.tsx         # オンライン状態管理Context
```

---

## 11. API設計

### 11.1 認証API

| エンドポイント | メソッド | 説明 | リクエスト | レスポンス | ステータス |
|--------------|---------|------|-----------|-----------|----------|
| `/api/auth/signup` | POST | ユーザー登録 | `{ email, password, name }` | `{ success, user }` | ✅ 実装済み |
| `/api/auth/login` | POST | ログイン | `{ email, password }` | `{ success, session }` | ✅ 実装済み |
| `/api/auth/logout` | POST | ログアウト | - | `{ success }` | ✅ 実装済み |
| `/api/auth/session` | GET | セッション確認 | - | `{ user }` | ✅ 実装済み |
| `/auth/callback` | GET | OAuth認証コールバック | - | リダイレクト | ✅ 実装済み |

**ソーシャルログイン**:
- Google OAuth: `signInWithOAuth({ provider: 'google' })`
- GitHub OAuth: `signInWithOAuth({ provider: 'github' })`
- 認証後、Prisma DBに自動的にユーザー情報を同期（upsert）

### 11.2 チャンネルAPI

| エンドポイント | メソッド | 説明 | リクエスト | レスポンス | ステータス |
|--------------|---------|------|-----------|-----------|----------|
| `/api/channels` | GET | チャンネル一覧取得 | `?userId=xxx` | `{ channels: [] }` | ✅ 実装済み |
| `/api/channels` | POST | チャンネル作成 | `{ name, description }` | `{ success, channel }` | ✅ 実装済み |
| `/api/channels/[channelId]` | DELETE | チャンネル削除 | - | `{ success }` | ✅ 実装済み |
| `/api/channels/join` | POST | チャンネル参加 | `{ channelId, userId }` | `{ success }` | ✅ 実装済み |
| `/api/channels/leave/[channelId]` | DELETE | チャンネル退出 | - | `{ success }` | ✅ 実装済み |
| `/api/channels/available` | GET | 参加可能チャンネル一覧 | `?userId=xxx` | `{ channels: [] }` | ✅ 実装済み |
| `/api/channels/all` | GET | 全チャンネル一覧 | - | `{ channels: [] }` | ✅ 実装済み |
| `/api/channel/[channelId]` | GET | 単一チャンネル詳細 | - | `{ channel }` | ✅ 実装済み |
| `/api/channels/[id]` | PATCH | チャンネル更新 | `{ name, description }` | `{ success, channel }` | 🔄 未実装 |

### 11.3 メッセージAPI

| エンドポイント | メソッド | 説明 | リクエスト | レスポンス | ステータス |
|--------------|---------|------|-----------|-----------|----------|
| `/api/messages/[channelId]` | GET | メッセージ一覧取得 | - | `{ messages: [] }` | ✅ 実装済み |
| `/api/messages/[channelId]` | POST | メッセージ送信 | `{ content, fileUrl?, fileName?, fileType?, fileSize? }` | `{ success, message }` | ✅ 実装済み |
| `/api/messages/[messageId]` | PATCH | メッセージ編集 | `{ content }` | `{ success, message }` | 🔄 未実装 |
| `/api/messages/[messageId]` | DELETE | メッセージ削除 | - | `{ success }` | 🔄 未実装 |

### 11.4 スレッドAPI

| エンドポイント | メソッド | 説明 | リクエスト | レスポンス | ステータス |
|--------------|---------|------|-----------|-----------|----------|
| `/api/threads/[messageId]` | GET | スレッド返信一覧取得 | - | `{ messages: [] }` | ✅ 実装済み |
| `/api/threads/[messageId]` | POST | スレッド返信送信 | `{ content }` | `{ success, message }` | ✅ 実装済み |

### 11.5 DMAPI

| エンドポイント | メソッド | 説明 | リクエスト | レスポンス | ステータス |
|--------------|---------|------|-----------|-----------|----------|
| `/api/dm/[partnerId]` | GET | DM取得（なければ作成） | - | `{ channel }` | ✅ 実装済み |
| `/api/dm/leave/[channelId]` | DELETE | DM退出（メッセージ履歴保持） | - | `{ success }` | ✅ 実装済み |

### 11.6 ファイル共有API

| エンドポイント | メソッド | 説明 | リクエスト | レスポンス | ステータス |
|--------------|---------|------|-----------|-----------|----------|
| `/api/upload` | POST | ファイルアップロード | FormData（file） | `{ success, url, fileName, fileType, fileSize }` | ✅ 実装済み |

**サポートファイル形式**:
- 画像: PNG, JPEG, GIF, WebP
- 動画: MP4, QuickTime, AVI
- ドキュメント: PDF, DOCX, XLSX, PPTX, DOC, XLS, PPT
- その他: ZIP, TXT

**制限**: 最大10MB

### 11.7 AIAPI

| エンドポイント | メソッド | 説明 | リクエスト | レスポンス | ステータス |
|--------------|---------|------|-----------|-----------|----------|
| `/api/ai/chat` | POST | AI質問（GPT-4o-mini） | `{ message, sessionId? }` | `{ response }` | ✅ 実装済み |
| `/api/ai/sessions` | GET | セッション一覧取得 | - | `{ sessions: [] }` | ✅ 実装済み |
| `/api/ai/sessions` | POST | 新規セッション作成 | `{ title? }` | `{ session }` | ✅ 実装済み |
| `/api/ai/sessions/[sessionId]` | GET | セッション詳細取得 | - | `{ session, chats: [] }` | ✅ 実装済み |
| `/api/ai/sessions/[sessionId]` | DELETE | セッション削除 | - | `{ success }` | ✅ 実装済み |

**AI機能の特徴**:
- GPT-4o-miniモデル使用
- セッション別会話管理（ChatGPT/Claude風）
- 会話コンテキスト保持（過去20件）
- タイトル自動生成
- リトライ処理・タイムアウト処理実装済み

### 11.8 ユーザーAPI

| エンドポイント | メソッド | 説明 | リクエスト | レスポンス | ステータス |
|--------------|---------|------|-----------|-----------|----------|
| `/api/users` | GET | 全ユーザー一覧取得 | - | `{ users: [] }` | ✅ 実装済み |
| `/api/user/[userId]` | GET | ユーザー情報取得 | - | `{ user }` | ✅ 実装済み |
| `/api/user/delete` | DELETE | アカウント削除 | - | `{ success }` | ✅ 実装済み |
| `/api/user/update-online-status` | POST | 最終オンライン時刻更新 | - | `{ success }` | ✅ 実装済み |
| `/api/avatar/upload` | POST | アバター画像アップロード | FormData（file） | `{ success, url }` | ✅ 実装済み |
| `/api/user/[userId]` | PATCH | ユーザー情報更新 | `{ name }` | `{ success, user }` | 🔄 未実装 |

### 11.9 その他

| エンドポイント | メソッド | 説明 | リクエスト | レスポンス | ステータス |
|--------------|---------|------|-----------|-----------|----------|
| `/api/channel-members` | GET | チャンネルメンバー一覧 | `?channelId=xxx` | `{ members: [] }` | ✅ 実装済み |
| `/api/dashboard` | GET | 統計情報取得 | - | `{ totalChannels, totalMessages, ... }` | ✅ 実装済み |

---

## 12. 認証・認可

### 12.1 認証フロー

#### メール認証

```
[サインアップ]
1. ユーザーがメール・パスワード・名前を入力
   ↓
2. Supabase Authにユーザー作成
   → authId（Supabase固有のユーザーID）が発行される
   ↓
3. Prisma DatabaseのUserテーブルに以下を保存:
   - id: 自動生成されたCUID
   - authId: SupabaseのユーザーID（連携キー）
   - name: ユーザー名
   - email: メールアドレス
   - avatarUrl: null（後で設定可能）
   - lastSeen: 現在時刻
   ↓
4. 自動ログイン → /workspace にリダイレクト

[ログイン]
1. ユーザーがメール・パスワードを入力
   ↓
2. Supabase Authでログイン認証
   → セッションCookie発行
   ↓
3. /workspace にリダイレクト
   ↓
4. Middleware で全リクエストのセッション検証
   → 無効な場合は /login にリダイレクト
   ↓
5. 最終オンライン時刻を更新（lastSeen）
```

#### ソーシャルログイン（Google/GitHub）

```
[ソーシャルログイン]
1. ユーザーがGoogle/GitHubボタンをクリック
   ↓
2. Supabase Auth の signInWithOAuth() を呼び出し
   ↓
3. プロバイダーの認証画面にリダイレクト
   ↓
4. ユーザーが認証を許可
   ↓
5. /auth/callback にリダイレクト（認証コード付き）
   ↓
6. コールバックハンドラーで認証コード→セッションに交換
   ↓
7. Supabase Auth から user_metadata を取得:
   - Google: picture (アバターURL), name
   - GitHub: avatar_url, name
   ↓
8. Prisma DBに upsert:
   - 既存ユーザー → lastSeen更新
   - 新規ユーザー → User作成（avatarUrl自動設定）
   ↓
9. /workspace にリダイレクト
```

### 12.2 認可（権限管理）

現在の権限モデル：

| リソース | 操作 | 権限ルール |
|---------|------|-----------|
| **メッセージ** | 送信 | チャンネルメンバーのみ |
| | 閲覧 | チャンネルメンバーのみ |
| | 編集 | 送信者本人のみ（未実装） |
| | 削除 | 送信者本人のみ（未実装） |
| | スレッド返信 | チャンネルメンバーのみ |
| **チャンネル** | 作成 | 全ユーザー |
| | 編集 | チャンネルメンバー全員（未実装） |
| | 削除 | チャンネル作成者のみ |
| | 参加 | 全ユーザー（パブリックチャンネルのみ） |
| | 退出 | チャンネルメンバーのみ |
| **DM** | 作成 | 全ユーザー |
| | 閲覧 | DM参加者2名のみ |
| | 退出 | DM参加者のみ |
| **ファイル** | アップロード | チャンネルメンバーのみ |
| | ダウンロード | チャンネルメンバーのみ |
| **AI** | 質問 | 全ユーザー |
| | セッション管理 | 自分のセッションのみ |
| **アカウント** | 削除 | 自分のアカウントのみ |
| | アバター変更 | 自分のアカウントのみ |

将来的な拡張案（Won't Have）:
- チャンネル管理者ロール
- モデレーター権限
- プライベートチャンネル

### 12.3 セキュリティ対策

| 対策 | 実装状況 | 説明 |
|------|---------|------|
| **HTTPS通信** | ✅ 実装済み | Supabase・Vercelは標準でHTTPS |
| **パスワードハッシュ化** | ✅ 実装済み | Supabase Authが自動処理 |
| **OAuth認証** | ✅ 実装済み | Google、GitHub OAuth対応 |
| **セッション管理** | ✅ 実装済み | Supabase AuthのCookie-based Session |
| **Middleware認証チェック** | ✅ 実装済み | 全リクエストでセッション検証 |
| **SQLインジェクション対策** | ✅ 実装済み | Prisma ORMのパラメータ化クエリ |
| **XSS対策** | ✅ 実装済み | React標準のエスケープ処理 |
| **CSRF対策** | ✅ 実装済み | Next.js標準のSameSite Cookie |
| **ファイルアップロード検証** | ✅ 実装済み | MIME type・ファイルサイズ制限（最大10MB） |
| **権限チェック** | ✅ 実装済み | チャンネル削除は作成者のみ、全APIで認証チェック |
| **レート制限** | 🔄 未実装 | 将来的にAPI制限を追加予定 |

---

## 13. データベーススキーマ

### 13.1 Prismaスキーマ詳細

```prisma
model User {
  id              String           @id @default(cuid())
  name            String
  email           String           @unique
  authId          String           @unique
  avatarUrl       String?
  lastSeen        DateTime         @default(now())
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt

  messages        Message[]
  channels        ChannelMember[]
  createdChannels Channel[]        @relation("ChannelCreator")
  aiChats         AiChat[]
  aiChatSessions  AiChatSession[]
}

model Channel {
  id          String          @id @default(cuid())
  name        String?
  description String?
  type        String
  creatorId   String?
  creator     User?           @relation("ChannelCreator", fields: [creatorId], references: [id], onDelete: SetNull)
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt

  members     ChannelMember[]
  messages    Message[]
}

model ChannelMember {
  id        String   @id @default(cuid())
  userId    String
  channelId String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  channel   Channel  @relation(fields: [channelId], references: [id], onDelete: Cascade)

  @@unique([userId, channelId])
}

model Message {
  id              String    @id @default(cuid())
  content         String
  senderId        String?
  channelId       String
  parentMessageId String?
  fileUrl         String?
  fileName        String?
  fileType        String?
  fileSize        Int?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  sender          User?     @relation(fields: [senderId], references: [id], onDelete: SetNull)
  channel         Channel   @relation(fields: [channelId], references: [id], onDelete: Cascade)
  parentMessage   Message?  @relation("MessageThread", fields: [parentMessageId], references: [id], onDelete: Cascade)
  replies         Message[] @relation("MessageThread")
}

model AiChatSession {
  id        String   @id @default(cuid())
  userId    String
  title     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  chats     AiChat[]
}

model AiChat {
  id        String         @id @default(cuid())
  userId    String
  sessionId String?
  message   String
  response  String
  createdAt DateTime       @default(now())

  user      User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  session   AiChatSession? @relation(fields: [sessionId], references: [id], onDelete: SetNull)
}
```

### 13.2 リレーション解説

**User ↔ Message**:
- 1人のユーザーは複数のメッセージを送信可能
- ユーザー削除時、送信者情報はnullに（メッセージは保持）

**User ↔ Channel** (ChannelMember経由):
- 多対多リレーション
- ユーザー削除時、メンバーシップ自動削除
- チャンネル削除時、メンバーシップ自動削除

**Channel ↔ Message**:
- 1つのチャンネルは複数のメッセージを持つ
- チャンネル削除時、メッセージも自動削除

**Message ↔ Message** (スレッド機能):
- 自己参照リレーション
- `parentMessageId`で親メッセージを指定
- 親メッセージ削除時、返信も自動削除

**User ↔ AiChatSession ↔ AiChat**:
- 1人のユーザーは複数のAIセッションを持つ
- 1つのセッションは複数の会話を持つ
- ユーザー削除時、セッション・会話も自動削除
- セッション削除時、会話の`sessionId`はnullに（会話は保持）

---

## 14. リアルタイム機能

### 14.1 Supabase Realtime実装

| 機能 | 実装方法 | トリガー | 実装状況 |
|-----|---------|---------|---------|
| 新着メッセージ通知 | PostgreSQL Changes | Message INSERT | ✅ 実装済み |
| スレッド返信通知 | PostgreSQL Changes | Message INSERT (parentMessageId指定) | ✅ 実装済み |
| ダッシュボード統計更新 | PostgreSQL Changes | Message/Channel INSERT/DELETE | ✅ 実装済み |
| オンライン状態表示 | Supabase Presence | ユーザーのプレゼンス状態 | ✅ 実装済み |

### 14.2 楽観的更新

送信者側で即座に画面更新を行い、ユーザー体験を向上させています。

```typescript
// メッセージ送信時
1. ユーザーが送信ボタンをクリック
2. 即座にローカル状態に新しいメッセージを追加（楽観的更新）
3. APIリクエスト送信
4. 成功したら何もしない（既に表示済み）
5. 失敗したらエラー表示 + ローカル状態から削除
```

### 14.3 マルチタブ同期

同じユーザーが複数タブを開いても、全タブでリアルタイム同期されます。

---

## 15. UI/UX特徴

### 15.1 ダークモード

- **実装ライブラリ**: next-themes v0.4.6
- **切り替え場所**: サイドバー下部の設定メニュー（歯車アイコン）
- **デフォルト**: ダークモード
- **アニメーション**: 0.8秒のスムーズなトランジション
- **永続化**: localStorage に自動保存
- **アイコン**: ライトモード時はMoonアイコン、ダークモード時はSunアイコン

### 15.2 検索機能

#### ユーザー検索
- **実装場所**:
  - DM開始ダイアログ（"新しいDM"ボタン）
  - ユーザー管理ダイアログ（サイドバー"ユーザー管理"）
- **検索対象**: ユーザー名、メールアドレス
- **機能**:
  - リアルタイムフィルタリング（大文字小文字区別なし）
  - オンライン状態表示
  - DMボタンクリック→DM作成→DMページに遷移

#### チャンネル検索
- **実装場所**: サイドバーの"チャンネル検索"ボタン
- **検索対象**: チャンネル名、説明
- **機能**:
  - リアルタイムフィルタリング
  - 参加状態表示（"参加"/"開く"ボタン）
  - メンバー数表示

### 15.3 オンライン状態表示

- **実装**: Supabase Presence使用
- **表示場所**: ユーザーアバター横の緑色ドット
- **機能**:
  - リアルタイムでオンライン/オフライン判定
  - "アクティブ"ラベル表示
  - 最終オンライン時刻記録

---

## 16. 次のアクションアイテム

### 優先度1（Should Have）

1. **メッセージ編集・削除機能**
   - PATCH/DELETE `/api/messages/[messageId]` 実装
   - UI上の編集・削除ボタン追加
   - 楽観的更新の実装
   - 権限チェック（送信者本人のみ）

2. **チャンネル編集機能**
   - PATCH `/api/channels/[channelId]` 実装
   - チャンネル名・説明の編集UI
   - 権限チェック（メンバー全員が編集可能）

3. **通知機能**
   - ブラウザ通知API統合
   - 新着メッセージバッジ表示
   - 通知設定ページ

### 優先度2（Could Have）

4. **メッセージ検索機能**
   - 全文検索APIの実装（Prismaの`contains`）
   - 検索UI（サイドバーまたはモーダル）

5. **リアクション機能**
   - メッセージへの絵文字リアクション
   - リアクション一覧表示
   - リアクション削除

6. **ユーザー名変更**
   - PATCH `/api/user/[userId]` 実装
   - プロフィール編集UI

7. **コードシンタックスハイライト**
   - Markdownパーサー統合
   - コードブロックの構文強調表示

---

## 17. テスト実装状況

| テスト種別 | カバレッジ | 実装状況 |
|----------|----------|---------|
| ユニットテスト | 60% | ✅ 実装済み |
| 統合テスト | 一部 | 🔄 進行中 |
| E2Eテスト | 未実装 | 🔄 未着手 |

**実装済みテスト**:
- コンポーネントのユニットテスト
- カスタムフックのユニットテスト
- Auth-serverのユニットテスト
- ソーシャルログインのテスト
- ダークモード切り替えのテスト
- ユーザー検索のテスト
- 統合テスト（一部）

---

## 18. まとめ

この要件定義書は、実際のプロジェクト実装状況を正確に反映しています。以下のポイントを押さえています：

### 18.1 実装済みの主要機能

1. **完全なチャット機能**: チャンネル・DM・リアルタイム配信
2. **ファイル共有**: 画像・ドキュメント・動画対応（最大10MB）
3. **スレッド機能**: Slack風のスレッドUI
4. **AI統合**: GPT-4o-miniによる学習支援、セッション管理
5. **オンライン状態**: Supabase Presenceによるリアルタイム追跡
6. **ソーシャルログイン**: Google、GitHub OAuth対応
7. **ダークモード**: next-themes統合、スムーズなアニメーション
8. **検索機能**: ユーザー検索、チャンネル検索（リアルタイムフィルタリング）
9. **チャンネル管理**: 作成・参加・退出・削除（編集のみ未実装）
10. **セキュリティ**: 認証・認可・バリデーション完備

### 18.2 未実装の機能（優先順位順）

1. **メッセージ編集・削除** (S)
2. **チャンネル編集** (S)
3. **通知機能** (S)
4. **メッセージ検索** (C)
5. **リアクション機能** (C)
6. **ユーザー名変更** (C)
7. **コードシンタックスハイライト** (C)
8. **プライベートチャンネル** (C)

### 18.3 技術的ハイライト

- **TypeScript完全対応**: 型安全性確保
- **Prisma ORM**: SQLインジェクション対策
- **Supabase統合**: 認証・Realtime・Presence・Storage
- **OpenAI API**: GPT-4o-mini統合
- **next-themes**: ダークモード実装
- **OAuth認証**: Google、GitHub対応
- **テストカバレッジ60%**: ユニットテスト実装済み
- **レスポンシブUI**: デスクトップ/モバイル対応

次のステップとして、このドキュメントを基に**未実装機能の実装計画**を立て、1つずつタスクを消化していくことをお勧めします。特に**メッセージ編集・削除**と**通知機能**はユーザー体験を大きく向上させるため、優先的に取り組むと良いでしょう。
