# ã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ—æ™‚ã®ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼å®Œå…¨ã‚¬ã‚¤ãƒ‰

**ä½œæˆæ—¥**: 2025å¹´10æœˆ27æ—¥
**å¯¾è±¡**: åˆå¿ƒè€…å‘ã‘
**å†…å®¹**: ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ—ã—ã¦ã‹ã‚‰ã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ä¿å­˜ã•ã‚Œã‚‹ã¾ã§ã®å®Œå…¨ãªæµã‚Œ

---

## æ¦‚è¦

ã“ã®ã‚¢ãƒ—ãƒªã§ã¯ã€**2ã¤ã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚·ã‚¹ãƒ†ãƒ **ã‚’é€£æºã•ã›ã¦ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’ç®¡ç†ã—ã¦ã„ã¾ã™ã€‚

### ä½¿ç”¨ã—ã¦ã„ã‚‹2ã¤ã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹

| ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ | å½¹å‰² | ä¿å­˜ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ |
|------------|------|--------------|
| **Supabase Auth Database** | èªè¨¼å°‚ç”¨ | ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã€ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã€èªè¨¼ãƒˆãƒ¼ã‚¯ãƒ³ã€user_metadata |
| **Prisma Database (PostgreSQL)** | ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ‡ãƒ¼ã‚¿ | ãƒ¦ãƒ¼ã‚¶ãƒ¼åã€ã‚¢ãƒã‚¿ãƒ¼ã€ã‚ªãƒ³ãƒ©ã‚¤ãƒ³çŠ¶æ…‹ã€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãªã© |

### ãªãœ2ã¤ã«åˆ†ã‹ã‚Œã¦ã„ã‚‹ã®ã‹ï¼Ÿ

- **Supabase Auth**: ã‚»ã‚­ãƒ¥ã‚¢ãªèªè¨¼æ©Ÿèƒ½ï¼ˆãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒãƒƒã‚·ãƒ¥åŒ–ã€ãƒˆãƒ¼ã‚¯ãƒ³ç®¡ç†ãªã©ï¼‰ã‚’æä¾›
- **Prisma Database**: ã‚¢ãƒ—ãƒªå›ºæœ‰ã®ãƒ‡ãƒ¼ã‚¿ï¼ˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å±¥æ­´ã€ãƒãƒ£ãƒ³ãƒãƒ«æƒ…å ±ãªã©ï¼‰ã‚’æŸ”è»Ÿã«ç®¡ç†

ã“ã®2ã¤ã‚’é€£æºã•ã›ã‚‹ã“ã¨ã§ã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã¨æŸ”è»Ÿæ€§ã‚’ä¸¡ç«‹ã—ã¦ã„ã¾ã™ã€‚

---

## ã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ—ã‹ã‚‰ãƒ­ã‚°ã‚¤ãƒ³ã¾ã§ã®å®Œå…¨ãƒ•ãƒ­ãƒ¼

### å…¨ä½“ã®æµã‚Œï¼ˆå›³è§£ï¼‰

```
ã€ã‚¹ãƒ†ãƒƒãƒ—1: ã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ—ã€‘
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ãƒ–ãƒ©ã‚¦ã‚¶: ã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ—ãƒšãƒ¼ã‚¸       â”‚
â”‚  http://localhost:3000/signup      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ãƒ¦ãƒ¼ã‚¶ãƒ¼å: [ã¡ãˆ        ]        â”‚ â† ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå…¥åŠ›
â”‚  ãƒ¡ãƒ¼ãƒ«:     [chie@example.com]   â”‚
â”‚  ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰: [â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢]            â”‚
â”‚                                    â”‚
â”‚      [ã‚¢ã‚«ã‚¦ãƒ³ãƒˆä½œæˆ] ãƒœã‚¿ãƒ³        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†“ ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Next.js Server Action             â”‚
â”‚  src/app/signup/actions.ts         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  1. formData ã‹ã‚‰å–å¾—:             â”‚
â”‚     - name: "ã¡ãˆ"                 â”‚
â”‚     - email: "chie@example.com"   â”‚
â”‚     - password: "â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢"        â”‚
â”‚                                    â”‚
â”‚  2. Zodãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œ          â”‚
â”‚     âœ… å½¢å¼ãƒã‚§ãƒƒã‚¯OK              â”‚
â”‚                                    â”‚
â”‚  3. Supabase Auth ã¸ãƒªã‚¯ã‚¨ã‚¹ãƒˆ:    â”‚
â”‚     supabase.auth.signUp({        â”‚
â”‚       email: "chie@example.com",  â”‚
â”‚       password: "â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢",       â”‚
â”‚       options: {                  â”‚
â”‚         data: {                   â”‚
â”‚           name: "ã¡ãˆ"  â† é‡è¦ï¼   â”‚
â”‚         }                         â”‚
â”‚       }                           â”‚
â”‚     })                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†“
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Supabase Auth Database            â”‚
â”‚  (èªè¨¼å°‚ç”¨ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹)             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  âœ… ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¬ã‚³ãƒ¼ãƒ‰ä½œæˆ:          â”‚
â”‚                                    â”‚
â”‚  â— id: "fb4861a4-..."  â† authId   â”‚
â”‚  â— email: "chie@example.com"      â”‚
â”‚  â— encrypted_password: "..."      â”‚
â”‚  â— email_confirmed_at: null       â”‚
â”‚  â— raw_user_meta_data: {          â”‚
â”‚      name: "ã¡ãˆ"  â† ã“ã“ã«ä¿å­˜ï¼  â”‚
â”‚    }                              â”‚
â”‚  â— display_name: (ç©º)             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†“
         â†“ ãƒ¡ãƒ¼ãƒ«ç¢ºèªãŒæœ‰åŠ¹ãªå ´åˆ
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Supabase ãŒç¢ºèªãƒ¡ãƒ¼ãƒ«ã‚’é€ä¿¡        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ä»¶å: Confirm Your Signup         â”‚
â”‚  æœ¬æ–‡: ä»¥ä¸‹ã®ãƒªãƒ³ã‚¯ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦    â”‚
â”‚        ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’æœ‰åŠ¹åŒ–ã—ã¦ãã ã•ã„ â”‚
â”‚                                    â”‚
â”‚  â†’ http://localhost:3000/          â”‚
â”‚     auth/callback?token_hash=...  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†“
         â†“ ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒ¡ãƒ¼ãƒ«ã®ãƒªãƒ³ã‚¯ã‚’ã‚¯ãƒªãƒƒã‚¯
         â†“
ã€ã‚¹ãƒ†ãƒƒãƒ—2: ãƒ¡ãƒ¼ãƒ«ç¢ºèªã€‘
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Next.js Route Handler             â”‚
â”‚  src/app/auth/callback/route.ts    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  1. èªè¨¼ã‚³ãƒ¼ãƒ‰ã‚’ã‚»ãƒƒã‚·ãƒ§ãƒ³ã«äº¤æ›    â”‚
â”‚     exchangeCodeForSession()       â”‚
â”‚                                    â”‚
â”‚  2. ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’å–å¾—:            â”‚
â”‚     const { user } = await         â”‚
â”‚       supabase.auth.getUser()      â”‚
â”‚                                    â”‚
â”‚  3. user_metadata ã‹ã‚‰åå‰å–å¾—:    â”‚
â”‚     userName =                     â”‚
â”‚       user.user_metadata?.name ||  â”‚
â”‚       user.email?.split('@')[0]    â”‚
â”‚     â†’ "ã¡ãˆ" ã‚’å–å¾—                â”‚
â”‚                                    â”‚
â”‚  4. Prisma ã¸ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆ:         â”‚
â”‚     await prisma.user.upsert({     â”‚
â”‚       where: { authId: user.id },  â”‚
â”‚       create: {                    â”‚
â”‚         authId: user.id,           â”‚
â”‚         name: "ã¡ãˆ",              â”‚
â”‚         email: "chie@example.com", â”‚
â”‚         isOnline: true,            â”‚
â”‚         lastSeen: new Date()       â”‚
â”‚       }                            â”‚
â”‚     })                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†“
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Prisma Database (PostgreSQL)      â”‚
â”‚  (ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹)      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  âœ… User ãƒ†ãƒ¼ãƒ–ãƒ«ã«ä½œæˆ:           â”‚
â”‚                                    â”‚
â”‚  â— id: "cmh8gyna6..." (Prisma ID) â”‚
â”‚  â— authId: "fb4861a4-..." â† é€£æº  â”‚
â”‚  â— name: "ã¡ãˆ"                   â”‚
â”‚  â— email: "chie@example.com"      â”‚
â”‚  â— avatarUrl: null                â”‚
â”‚  â— isOnline: true                 â”‚
â”‚  â— lastSeen: 2025-10-27 10:30:00  â”‚
â”‚  â— createdAt: 2025-10-27 10:30:00 â”‚
â”‚  â— updatedAt: 2025-10-27 10:30:00 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†“
         â†“ ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ãƒ–ãƒ©ã‚¦ã‚¶: ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ãƒšãƒ¼ã‚¸     â”‚
â”‚  http://localhost:3000/workspace   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  âœ… ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸï¼                 â”‚
â”‚  âœ… ã€Œã¡ãˆã€ã•ã‚“ã¨ã—ã¦è¡¨ç¤º          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## è©³ç´°è§£èª¬

### ã‚¹ãƒ†ãƒƒãƒ—1: ãƒ•ã‚©ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿ã®å–å¾—

**ãƒ•ã‚¡ã‚¤ãƒ«**: `src/app/signup/page.tsx:183-306`

ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒ•ã‚©ãƒ¼ãƒ ã«å…¥åŠ›ã—ãŸå†…å®¹ã‚’ Server Action ã«é€ä¿¡ã—ã¾ã™ã€‚

```tsx
<form action={formAction} className="space-y-4">
  {/* ãƒ¦ãƒ¼ã‚¶ãƒ¼åå…¥åŠ› */}
  <div>
    <label htmlFor="name">ãƒ¦ãƒ¼ã‚¶ãƒ¼å</label>
    <Input
      id="name"
      name="name"  â† ã“ã® name å±æ€§ãŒé‡è¦ï¼
      type="text"
      required
      placeholder="ã‚ãªãŸã®åå‰"
      maxLength={50}
    />
  </div>

  {/* ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹å…¥åŠ› */}
  <div>
    <label htmlFor="email">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</label>
    <Input
      id="email"
      name="email"  â† ã“ã® name å±æ€§ãŒé‡è¦ï¼
      type="email"
      required
      placeholder="your-email@example.com"
    />
  </div>

  {/* ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å…¥åŠ› */}
  <div>
    <label htmlFor="password">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
    <Input
      id="password"
      name="password"  â† ã“ã® name å±æ€§ãŒé‡è¦ï¼
      type="password"
      required
      placeholder="8æ–‡å­—ä»¥ä¸Š"
    />
  </div>

  <SignupButton />
</form>
```

**ãƒã‚¤ãƒ³ãƒˆ**:
- `name` å±æ€§ã®å€¤ãŒã€Server Action ã§ `formData.get('name')` ã¨ã—ã¦å–å¾—ã•ã‚Œã¾ã™
- React ã® `useActionState` ã‚’ä½¿ç”¨ã—ã¦ã€ã‚µãƒ¼ãƒãƒ¼å´ã®å‡¦ç†ã¨çŠ¶æ…‹ã‚’ç®¡ç†

---

### ã‚¹ãƒ†ãƒƒãƒ—2: Server Action ã§ã®å‡¦ç†

**ãƒ•ã‚¡ã‚¤ãƒ«**: `src/app/signup/actions.ts:43-163`

#### 2-1. ãƒ•ã‚©ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã¨ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³

```typescript
export async function signup(prevState: ActionResult | null, formData: FormData): Promise<ActionResult> {
  const supabase = await createClient()

  // ãƒ•ã‚©ãƒ¼ãƒ ã‹ã‚‰ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’å–å¾—
  const rawData = {
    email: formData.get('email') as string,      // "chie@example.com"
    password: formData.get('password') as string, // "â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢"
    name: formData.get('name') as string,        // "ã¡ãˆ"
  }

  // Zodãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆå‹å®‰å…¨ãªãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ï¼‰
  const validation = signupSchema.safeParse(rawData)

  if (!validation.success) {
    // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ©ãƒ¼æ™‚ã€æœ€åˆã®ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¿”ã™
    const errorMessage = validation.error.issues[0]?.message || 'ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ©ãƒ¼'
    console.error('âŒ ã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ—ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ©ãƒ¼:', errorMessage)
    return { error: errorMessage }
  }

  const data = validation.data
  // ã“ã“ã‹ã‚‰å…ˆã¯ã€å‹å®‰å…¨ãª data ã‚’ä½¿ç”¨
```

**ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³å†…å®¹** (`src/lib/validations.ts`):
```typescript
export const signupSchema = z.object({
  email: z.string().email('æ­£ã—ã„ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹å½¢å¼ã§å…¥åŠ›ã—ã¦ãã ã•ã„'),
  password: z.string().min(8, 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯8æ–‡å­—ä»¥ä¸Šã§å…¥åŠ›ã—ã¦ãã ã•ã„'),
  name: z.string().min(1, 'ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„').max(50, 'ãƒ¦ãƒ¼ã‚¶ãƒ¼åã¯50æ–‡å­—ä»¥å†…ã§å…¥åŠ›ã—ã¦ãã ã•ã„'),
})
```

#### 2-2. Supabase Auth ã¸ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²

```typescript
  // Supabaseã§ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²å‡¦ç†ã‚’å®Ÿè¡Œ
  const { data: authData, error } = await supabase.auth.signUp({
    email: data.email,         // "chie@example.com"
    password: data.password,   // "â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢"
    options: {
      data: {
        name: data.name,       // "ã¡ãˆ" â† ã“ã‚ŒãŒ raw_user_meta_data ã«ä¿å­˜ã•ã‚Œã‚‹
      },
    },
  })

  if (error) {
    console.error('âŒ ã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ—ã‚¨ãƒ©ãƒ¼:', error.message)

    // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æ—¥æœ¬èªã«å¤‰æ›
    let errorMessage = 'ã‚¢ã‚«ã‚¦ãƒ³ãƒˆä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ'
    if (error.message.includes('User already registered')) {
      errorMessage = 'ã“ã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¯æ—¢ã«ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã™'
    }

    return { error: errorMessage }
  }
```

**Supabaseã¸ã®é€ä¿¡å†…å®¹**:
```json
{
  "email": "chie@example.com",
  "password": "ãƒãƒƒã‚·ãƒ¥åŒ–ã•ã‚Œã‚‹å‰ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰",
  "options": {
    "data": {
      "name": "ã¡ãˆ"
    }
  }
}
```

**Supabase Auth Database ã«ä¿å­˜ã•ã‚Œã‚‹å†…å®¹**:
```json
{
  "id": "fb4861a4-4ca9-4aa4-9545-cff1572157a1",
  "email": "chie@example.com",
  "encrypted_password": "$2a$10$...",  // ãƒãƒƒã‚·ãƒ¥åŒ–æ¸ˆã¿
  "email_confirmed_at": null,           // ãƒ¡ãƒ¼ãƒ«ç¢ºèªå‰ãªã®ã§ null
  "raw_user_meta_data": {
    "name": "ã¡ãˆ"  // â† ã“ã“ã«ä¿å­˜ã•ã‚Œã‚‹ï¼
  },
  "display_name": null,                 // è¨­å®šã—ã¦ã„ãªã„ã®ã§ null
  "created_at": "2025-10-27T01:30:00Z"
}
```

#### 2-3. ãƒ¡ãƒ¼ãƒ«ç¢ºèªãƒã‚§ãƒƒã‚¯

```typescript
  // ãƒ¡ãƒ¼ãƒ«ç¢ºèªãŒå¿…è¦ã‹ã©ã†ã‹ã‚’ãƒã‚§ãƒƒã‚¯
  // Supabaseã®è¨­å®šã§ã€ŒConfirm emailã€ãŒæœ‰åŠ¹ãªå ´åˆã€session ã¯ null ã«ãªã‚‹
  const requiresEmailConfirmation = !authData.session

  if (requiresEmailConfirmation) {
    console.log('ğŸ“§ ãƒ¡ãƒ¼ãƒ«ç¢ºèªãŒå¿…è¦ã§ã™:', data.email)

    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ãƒ¡ãƒ¼ãƒ«ç¢ºèªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
    return {
      success: 'ç¢ºèªãƒ¡ãƒ¼ãƒ«ã‚’é€ä¿¡ã—ã¾ã—ãŸ',
      requiresEmailConfirmation: true
    }
  }
```

**é‡è¦**:
- `authData.session` ãŒ `null` = ãƒ¡ãƒ¼ãƒ«ç¢ºèªãŒå¿…è¦
- `authData.session` ãŒå­˜åœ¨ = ã™ãã«ãƒ­ã‚°ã‚¤ãƒ³å¯èƒ½ï¼ˆãƒ¡ãƒ¼ãƒ«ç¢ºèªä¸è¦ï¼‰

#### 2-4. Prisma ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆï¼ˆãƒ¡ãƒ¼ãƒ«ç¢ºèªä¸è¦ã®å ´åˆã®ã¿ï¼‰

```typescript
  // ãƒ¡ãƒ¼ãƒ«ç¢ºèªãŒä¸è¦ãªå ´åˆï¼ˆã¾ãŸã¯æ—¢ã«ç¢ºèªæ¸ˆã¿ã®å ´åˆï¼‰ã®ã¿å®Ÿè¡Œ
  if (authData.user) {
    try {
      await prisma.user.create({
        data: {
          authId: authData.user.id,     // Supabaseãƒ¦ãƒ¼ã‚¶ãƒ¼ã® ID
          email: data.email,
          name: data.name,
          isOnline: true,                // ã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ—ç›´å¾Œã¯ã‚ªãƒ³ãƒ©ã‚¤ãƒ³
          lastSeen: new Date(),          // ç¾åœ¨æ™‚åˆ»ã‚’è¨­å®š
        },
      })
      console.log('âœ… Prisma User created successfully')
    } catch (prismaError: any) {
      console.error('âŒ Prisma User creation error:', prismaError)
      // ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
    }
  }

  // ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
  revalidatePath('/', 'layout')
  redirect('/workspace')
}
```

---

### ã‚¹ãƒ†ãƒƒãƒ—3: ãƒ¡ãƒ¼ãƒ«ç¢ºèªï¼ˆãƒ¡ãƒ¼ãƒ«ç¢ºèªãŒæœ‰åŠ¹ãªå ´åˆï¼‰

#### 3-1. ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒ¡ãƒ¼ãƒ«ã®ãƒªãƒ³ã‚¯ã‚’ã‚¯ãƒªãƒƒã‚¯

Supabaseã‹ã‚‰é€ä¿¡ã•ã‚Œã‚‹ãƒ¡ãƒ¼ãƒ«ã®ä¾‹:
```
ä»¶å: Confirm Your Signup

ã“ã‚“ã«ã¡ã¯ï¼

ä»¥ä¸‹ã®ãƒªãƒ³ã‚¯ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ã€ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’æœ‰åŠ¹åŒ–ã—ã¦ãã ã•ã„:

http://localhost:3000/auth/callback?token_hash=xxx&type=email

ã“ã®ãƒ¡ãƒ¼ãƒ«ã«å¿ƒå½“ãŸã‚ŠãŒãªã„å ´åˆã¯ã€ç„¡è¦–ã—ã¦ãã ã•ã„ã€‚
```

#### 3-2. èªè¨¼ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯å‡¦ç†

**ãƒ•ã‚¡ã‚¤ãƒ«**: `src/app/auth/callback/route.ts:15-129`

```typescript
export async function GET(request: NextRequest) {
  const { searchParams, origin } = new URL(request.url)
  const code = searchParams.get('code')  // èªè¨¼ã‚³ãƒ¼ãƒ‰å–å¾—

  if (code) {
    const supabase = await createClient()

    try {
      // ã‚¹ãƒ†ãƒƒãƒ—A: èªè¨¼ã‚³ãƒ¼ãƒ‰ã‚’ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒˆãƒ¼ã‚¯ãƒ³ã«äº¤æ›
      const { error: exchangeError } = await supabase.auth.exchangeCodeForSession(code)

      if (exchangeError) {
        console.error('âŒ ã‚»ãƒƒã‚·ãƒ§ãƒ³äº¤æ›ã‚¨ãƒ©ãƒ¼:', exchangeError)
        return NextResponse.redirect(`${origin}/login`)
      }

      // ã‚¹ãƒ†ãƒƒãƒ—B: ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸï¼šãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’å–å¾—
      const { data: { user }, error: userError } = await supabase.auth.getUser()

      if (userError || !user) {
        console.error('âŒ ãƒ¦ãƒ¼ã‚¶ãƒ¼å–å¾—ã‚¨ãƒ©ãƒ¼:', userError)
        return NextResponse.redirect(`${origin}/login`)
      }

      console.log('âœ… ãƒ¦ãƒ¼ã‚¶ãƒ¼èªè¨¼æˆåŠŸ:', user.email)

      // ã‚¹ãƒ†ãƒƒãƒ—C: user_metadata ã‹ã‚‰åå‰ã¨ã‚¢ãƒã‚¿ãƒ¼ã‚’å–å¾—
      const userName = user.user_metadata?.name ||
                      user.user_metadata?.full_name ||
                      user.email?.split('@')[0] ||
                      'Unknown User'

      const avatarUrl = user.user_metadata?.avatar_url ||
                       user.user_metadata?.picture ||
                       null

      console.log('ğŸ”„ Prismaãƒ¦ãƒ¼ã‚¶ãƒ¼åŒæœŸé–‹å§‹:', {
        authId: user.id,
        email: user.email,
        userName,
        avatarUrl: avatarUrl ? 'æœ‰ã‚Š' : 'ç„¡ã—',
      })

      // ã‚¹ãƒ†ãƒƒãƒ—D: Prisma Database ã«ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’åŒæœŸ
      try {
        const prismaUser = await prisma.user.upsert({
          where: { authId: user.id },
          update: {
            // æ—¢å­˜ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å ´åˆã¯åå‰ã€ãƒ¡ãƒ¼ãƒ«ã€ã‚¢ãƒã‚¿ãƒ¼ã€ã‚ªãƒ³ãƒ©ã‚¤ãƒ³çŠ¶æ…‹ã‚’æ›´æ–°
            name: userName,
            email: user.email || '',
            avatarUrl: avatarUrl,
            isOnline: true,
            lastSeen: new Date(),
          },
          create: {
            // æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å ´åˆã¯ä½œæˆ
            authId: user.id,
            name: userName,
            email: user.email || '',
            avatarUrl: avatarUrl,
            isOnline: true,
            lastSeen: new Date(),
          },
        })

        console.log('âœ… Prismaã«ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’åŒæœŸæˆåŠŸ:', {
          id: prismaUser.id,
          authId: prismaUser.authId,
          name: prismaUser.name,
          email: prismaUser.email,
        })
      } catch (dbError: any) {
        console.error('âŒ Prismaãƒ¦ãƒ¼ã‚¶ãƒ¼åŒæœŸã‚¨ãƒ©ãƒ¼:', dbError)
        return NextResponse.redirect(
          `${origin}/login?error=ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹åŒæœŸã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚`
        )
      }

      // ã‚¹ãƒ†ãƒƒãƒ—E: ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ãƒšãƒ¼ã‚¸ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
      return NextResponse.redirect(`${origin}/workspace`)
    } catch (error) {
      console.error('âŒ èªè¨¼ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚¨ãƒ©ãƒ¼:', error)
      return NextResponse.redirect(`${origin}/login`)
    }
  }

  return NextResponse.redirect(`${origin}/login`)
}
```

---

### ã‚¹ãƒ†ãƒƒãƒ—4: ãƒ­ã‚°ã‚¤ãƒ³æ™‚ã®å‡¦ç†ï¼ˆåˆå›ãƒ­ã‚°ã‚¤ãƒ³ã®å ´åˆï¼‰

ãƒ¡ãƒ¼ãƒ«ç¢ºèªå¾Œã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒ­ã‚°ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ã‹ã‚‰ãƒ­ã‚°ã‚¤ãƒ³ã—ãŸå ´åˆã®å‡¦ç†ã€‚

**ãƒ•ã‚¡ã‚¤ãƒ«**: `src/app/login/actions.ts:84-122`

```typescript
  // ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸæ™‚: Prismaãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ä½œæˆ/æ›´æ–°
  if (authData.user) {
    try {
      // user_metadata ã‹ã‚‰åå‰ã¨ã‚¢ãƒã‚¿ãƒ¼ã‚’å–å¾—
      const userName = authData.user.user_metadata?.name ||
                      authData.user.user_metadata?.full_name ||
                      authData.user.email?.split('@')[0] ||
                      'Unknown User'

      const avatarUrl = authData.user.user_metadata?.avatar_url ||
                       authData.user.user_metadata?.picture ||
                       null

      // upsert: ãƒ¬ã‚³ãƒ¼ãƒ‰ãŒã‚ã‚Œã°æ›´æ–°ã€ãªã‘ã‚Œã°ä½œæˆ
      await prisma.user.upsert({
        where: { authId: authData.user.id },
        update: {
          // æ—¢å­˜ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å ´åˆã¯ã‚ªãƒ³ãƒ©ã‚¤ãƒ³çŠ¶æ…‹ã‚’æ›´æ–°
          isOnline: true,
          lastSeen: new Date(),
        },
        create: {
          // æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å ´åˆã¯ä½œæˆï¼ˆãƒ¡ãƒ¼ãƒ«ç¢ºèªå¾Œã®åˆå›ãƒ­ã‚°ã‚¤ãƒ³ï¼‰
          authId: authData.user.id,
          name: userName,
          email: authData.user.email || '',
          avatarUrl: avatarUrl,
          isOnline: true,
          lastSeen: new Date(),
        },
      })
      console.log('âœ… Prismaãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ä½œæˆ/æ›´æ–°ã—ã¾ã—ãŸ:', authData.user.email)
    } catch (dbError: any) {
      console.error('âŒ Prismaãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆ/æ›´æ–°ã‚¨ãƒ©ãƒ¼:', dbError)
      // DBæ›´æ–°å¤±æ•—ã—ã¦ã‚‚ãƒ­ã‚°ã‚¤ãƒ³ã¯æˆåŠŸã¨ã™ã‚‹ï¼ˆè‡´å‘½çš„ã§ã¯ãªã„ï¼‰
    }
  }

  revalidatePath('/', 'layout')
  redirect('/workspace')
```

---

## ãƒ‡ãƒ¼ã‚¿ã®å¯¾å¿œé–¢ä¿‚

### Supabase Auth â†” Prisma Database ã®é€£æº

| Supabase Auth | Prisma Database | èª¬æ˜ |
|--------------|----------------|------|
| `user.id` | `User.authId` | **é€£æºã‚­ãƒ¼**ï¼ˆãƒ¦ãƒ‹ãƒ¼ã‚¯åˆ¶ç´„ï¼‰ |
| `user.email` | `User.email` | ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ |
| `user.user_metadata.name` | `User.name` | ãƒ¦ãƒ¼ã‚¶ãƒ¼å |
| `user.user_metadata.avatar_url` | `User.avatarUrl` | ã‚¢ãƒã‚¿ãƒ¼URLï¼ˆã‚½ãƒ¼ã‚·ãƒ£ãƒ«èªè¨¼æ™‚ï¼‰ |
| - | `User.isOnline` | ã‚ªãƒ³ãƒ©ã‚¤ãƒ³çŠ¶æ…‹ï¼ˆPrismaå°‚ç”¨ï¼‰ |
| - | `User.lastSeen` | æœ€çµ‚ãƒ­ã‚°ã‚¤ãƒ³æ™‚åˆ»ï¼ˆPrismaå°‚ç”¨ï¼‰ |

### Display Name ã«ã¤ã„ã¦

| ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ | ä¿å­˜å ´æ‰€ | ç”¨é€” | è¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹ |
|----------|---------|------|----------------|
| `display_name` | Supabase Auth | ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰è¡¨ç¤ºç”¨ | âŒ æœªè¨­å®šï¼ˆç©ºï¼‰ |
| `raw_user_meta_data.name` | Supabase Auth | ã‚¢ãƒ—ãƒªãŒä½¿ç”¨ã™ã‚‹åå‰ | âœ… è¨­å®šæ¸ˆã¿ |
| `User.name` | Prisma Database | ã‚¢ãƒ—ãƒªãŒä½¿ç”¨ã™ã‚‹åå‰ | âœ… è¨­å®šæ¸ˆã¿ |

**é‡è¦**: `display_name` ãŒç©ºã§ã‚‚ã€`raw_user_meta_data.name` ã«å€¤ãŒã‚ã‚Œã°ã‚¢ãƒ—ãƒªã¯æ­£å¸¸å‹•ä½œã—ã¾ã™ã€‚

---

## ã‚ˆãã‚ã‚‹è³ªå•

### Q1: ãªãœ2ã¤ã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’ä½¿ã†ã®ã§ã™ã‹ï¼Ÿ

**A**: å½¹å‰²åˆ†æ‹…ã®ãŸã‚ã§ã™ã€‚

- **Supabase Auth**: èªè¨¼å°‚ç”¨ã«ç‰¹åŒ–ã—ãŸãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã€‚ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒãƒƒã‚·ãƒ¥åŒ–ã€ãƒˆãƒ¼ã‚¯ãƒ³ç®¡ç†ã€ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†ãªã©ã€ã‚»ã‚­ãƒ¥ã‚¢ãªèªè¨¼æ©Ÿèƒ½ã‚’æä¾›ã—ã¾ã™ã€‚
- **Prisma Database**: ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å›ºæœ‰ã®ãƒ‡ãƒ¼ã‚¿ã‚’æŸ”è»Ÿã«ç®¡ç†ã§ãã¾ã™ã€‚ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã€ãƒãƒ£ãƒ³ãƒãƒ«ã€ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãªã©ã€è¤‡é›‘ãªãƒ‡ãƒ¼ã‚¿æ§‹é€ ã‚’æ‰±ã„ã‚„ã™ãã—ã¾ã™ã€‚

### Q2: `raw_user_meta_data` ã¨ã¯ä½•ã§ã™ã‹ï¼Ÿ

**A**: Supabase AuthãŒæä¾›ã™ã‚‹ã€**ã‚«ã‚¹ã‚¿ãƒ ãƒ‡ãƒ¼ã‚¿ä¿å­˜é ˜åŸŸ**ã§ã™ã€‚

ã‚¢ãƒ—ãƒªå´ã§è‡ªç”±ã«ä½¿ãˆã‚‹JSONãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã§ã€ã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ—æ™‚ã« `options.data` ã¨ã—ã¦æ¸¡ã—ãŸãƒ‡ãƒ¼ã‚¿ãŒä¿å­˜ã•ã‚Œã¾ã™ã€‚

```typescript
// ã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ—æ™‚
supabase.auth.signUp({
  email: "user@example.com",
  password: "password",
  options: {
    data: {
      name: "ãƒ¦ãƒ¼ã‚¶ãƒ¼å",  // â† ã“ã‚ŒãŒ raw_user_meta_data ã«ä¿å­˜ã•ã‚Œã‚‹
      favorite_color: "blue"  // ã‚«ã‚¹ã‚¿ãƒ ãƒ‡ãƒ¼ã‚¿ã‚‚è‡ªç”±ã«è¿½åŠ å¯èƒ½
    }
  }
})

// å–å¾—æ™‚
const userName = user.user_metadata?.name  // "ãƒ¦ãƒ¼ã‚¶ãƒ¼å"
const color = user.user_metadata?.favorite_color  // "blue"
```

### Q3: ãƒ¡ãƒ¼ãƒ«ç¢ºèªã‚’ã‚¹ã‚­ãƒƒãƒ—ã§ãã¾ã™ã‹ï¼Ÿ

**A**: é–‹ç™ºç’°å¢ƒã§ã¯å¯èƒ½ã§ã™ï¼ˆæœ¬ç•ªç’°å¢ƒã§ã¯éæ¨å¥¨ï¼‰ã€‚

Supabaseãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰:
1. **Authentication** â†’ **Providers** â†’ **Email**
2. **Confirm email** ã‚’ **OFF** ã«è¨­å®š

ã“ã‚Œã«ã‚ˆã‚Šã€ã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ—ç›´å¾Œã«ãƒ­ã‚°ã‚¤ãƒ³å¯èƒ½ã«ãªã‚Šã¾ã™ã€‚

### Q4: `upsert` ã¨ã¯ä½•ã§ã™ã‹ï¼Ÿ

**A**: **Update ã¾ãŸã¯ Insert** ã®ç•¥ã§ã€ã€Œæ—¢ã«ã‚ã‚Œã°æ›´æ–°ã€ãªã‘ã‚Œã°ä½œæˆã€ã™ã‚‹æ“ä½œã§ã™ã€‚

```typescript
await prisma.user.upsert({
  where: { authId: user.id },  // ã“ã®æ¡ä»¶ã§æ¤œç´¢
  update: { isOnline: true },  // è¦‹ã¤ã‹ã‚Œã°æ›´æ–°
  create: { authId: user.id, name: "ã¡ãˆ" }  // ãªã‘ã‚Œã°ä½œæˆ
})
```

**ãƒ¡ãƒªãƒƒãƒˆ**:
- åˆå›ãƒ­ã‚°ã‚¤ãƒ³ã‹å†ãƒ­ã‚°ã‚¤ãƒ³ã‹ã‚’æ°—ã«ã›ãšä½¿ãˆã‚‹
- ã‚³ãƒ¼ãƒ‰ãŒã‚·ãƒ³ãƒ—ãƒ«ã«ãªã‚‹

### Q5: ã‚½ãƒ¼ã‚·ãƒ£ãƒ«èªè¨¼ï¼ˆGoogleã€GitHubãªã©ï¼‰ã®å ´åˆã¯ã©ã†ãªã‚Šã¾ã™ã‹ï¼Ÿ

**A**: åŸºæœ¬çš„ãªæµã‚Œã¯åŒã˜ã§ã™ãŒã€`user_metadata` ã®å–å¾—å…ƒãŒç•°ãªã‚Šã¾ã™ã€‚

```typescript
// Googleèªè¨¼ã®å ´åˆ
const userName = user.user_metadata?.full_name ||  // Googleã‹ã‚‰å–å¾—
                user.user_metadata?.name ||
                user.email?.split('@')[0]

const avatarUrl = user.user_metadata?.picture ||  // Googleã®ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç”»åƒ
                 null

// GitHubèªè¨¼ã®å ´åˆ
const userName = user.user_metadata?.name ||  // GitHubã‹ã‚‰å–å¾—
                user.email?.split('@')[0]

const avatarUrl = user.user_metadata?.avatar_url ||  // GitHubã®ã‚¢ãƒã‚¿ãƒ¼
                 null
```

---

## ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼å›³ï¼ˆã¾ã¨ã‚ï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     ã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ—ãƒ•ãƒ­ãƒ¼                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

1. ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›
   â†“
2. signup/actions.ts
   â”œâ”€ formData.get('name') â†’ "ã¡ãˆ"
   â”œâ”€ Zodãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
   â””â”€ supabase.auth.signUp({ options: { data: { name: "ã¡ãˆ" } } })
   â†“
3. Supabase Auth Database
   â”œâ”€ email: "chie@example.com"
   â”œâ”€ encrypted_password: "ãƒãƒƒã‚·ãƒ¥åŒ–æ¸ˆã¿"
   â””â”€ raw_user_meta_data: { name: "ã¡ãˆ" } â† ä¿å­˜
   â†“
4. ãƒ¡ãƒ¼ãƒ«ç¢ºèªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
   â†“
5. ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒ¡ãƒ¼ãƒ«ãƒªãƒ³ã‚¯ã‚’ã‚¯ãƒªãƒƒã‚¯
   â†“
6. auth/callback/route.ts
   â”œâ”€ exchangeCodeForSession()
   â”œâ”€ getUser() â†’ user.user_metadata.name = "ã¡ãˆ"
   â””â”€ prisma.user.upsert({ create: { name: "ã¡ãˆ", ... } })
   â†“
7. Prisma Database (PostgreSQL)
   â”œâ”€ authId: "fb4861a4-..." (Supabaseã¨é€£æº)
   â”œâ”€ name: "ã¡ãˆ"
   â”œâ”€ email: "chie@example.com"
   â”œâ”€ isOnline: true
   â””â”€ lastSeen: 2025-10-27 10:30:00
   â†“
8. /workspace ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
   â†“
âœ… ãƒ­ã‚°ã‚¤ãƒ³å®Œäº†ï¼
```

---

## é–¢é€£ãƒ•ã‚¡ã‚¤ãƒ«

### ã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ—é–¢é€£
- `src/app/signup/page.tsx` - ã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ—ãƒšãƒ¼ã‚¸UI
- `src/app/signup/actions.ts` - ã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ—Server Action
- `src/lib/validations.ts` - Zodãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¹ã‚­ãƒ¼ãƒ

### èªè¨¼ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯
- `src/app/auth/callback/route.ts` - ãƒ¡ãƒ¼ãƒ«ç¢ºèªå¾Œã®å‡¦ç†

### ãƒ­ã‚°ã‚¤ãƒ³é–¢é€£
- `src/app/login/page.tsx` - ãƒ­ã‚°ã‚¤ãƒ³ãƒšãƒ¼ã‚¸UI
- `src/app/login/actions.ts` - ãƒ­ã‚°ã‚¤ãƒ³Server Action

### Supabaseè¨­å®š
- `src/lib/supabase/server.ts` - ã‚µãƒ¼ãƒãƒ¼å´Supabaseã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ
- `src/lib/supabase/client.ts` - ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´Supabaseã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ

### ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹
- `prisma/schema.prisma` - Prismaã‚¹ã‚­ãƒ¼ãƒå®šç¾©
- `src/lib/prisma.ts` - Prisma Clientã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹

---

## å‚è€ƒè³‡æ–™

- [Supabase Auth ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://supabase.com/docs/guides/auth)
- [Prisma ORM ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://www.prisma.io/docs)
- [Next.js Server Actions](https://nextjs.org/docs/app/building-your-application/data-fetching/server-actions-and-mutations)
- [Zod ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³](https://zod.dev/)

---

**æœ€çµ‚æ›´æ–°**: 2025å¹´10æœˆ27æ—¥
**å‹•ä½œç¢ºèª**: âœ… æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ã€Œã¡ãˆã€ã§ã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ—ãƒ»ãƒ¡ãƒ¼ãƒ«ç¢ºèªãƒ»ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸ
